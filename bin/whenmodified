#!/bin/sh
# whenmodified - Explanation goes here
# Created: Fri Dec  4 10:19:56 MYT 2009

. ~/.shell/osd.rc
usage() {
	echo "whenmodified [-f(forever)] [-d <delay>] -c whattodo 'cmd to get files to monitor'"
}

clear=
delay=.1
whattodo=
while getopts fhc:Cd: opt
do
	case "$opt" in
    d) delay=$OPTARG;;
    f) FOREVER=1;;
    C) clear=t ;;
    c) whattodo="$OPTARG";;
    h) usage ; exit;;
	\?) echo Unknown option ; exit;;
	esac
done
shift $(($OPTIND -1))

if [ -z "$whattodo" ]; then
    usage
    exit 1;
fi

if [ -z "$*" ]; then
    usage
    exit 1;
fi

maybeClear() {
    test -n "$clear" && clear
}

headline() {
    echo "[PENDING] $whattodo [MODIFIED] $modifiedfiles"
}


events=modify,attrib,close_write,moved_to,moved_from,move,move_self,create,delete,delete_self

if ! which inotifywait >/dev/null; then
    echo "inotifywait not available"
    exit 1
fi

inotifycmd="inotifywait -e $events -q -q"
modifiedfiles=$*
maybeClear
headline
while true; do
    $inotifycmd $(eval $modifiedfiles) && {
	sleep $delay
	maybeClear
	echo "$whattodo"
	echo "$whattodo"|osd --font='DeJavu Sans Mono 16' &
	eval "$whattodo"
    }
    if [ ! $FOREVER ]; then
	    break;
    fi
    headline
done
