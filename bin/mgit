#!/bin/sh
# vim: ts=2 sts=2 sw=2 expandtab
# Created: Tue Nov  6 10:47:19 MYT 2012

. `dirname $0`/common.sh

me=`basename $0`
usage() {
cat <<EOF
NAME
  $me - Run git commands for each git repositories under current directory

PURPOSE
  Run git command on multiple git repositories and format the
  output as if they come from a single repository (using the -p
  option) - works good only for ls-files.

SYNOPSIS
  $me [-hq] <git args>

OPTIONS
  -c
    pass -c ui.color=always to git
  -d <dir1,dir2,...>
    Run git command in <dir1,dir2,...> only
  -p
    Prepend dirname of git repo foreach line of output
  -v
    Be verbose - show directory being worked on
  -h
    Show this help message
EOF
}

dirs=
verbose=
add_prefix=
color_always=
while getopts cd:hpv opt
do
  case "$opt" in
    c) color_always="-c color.ui=always";;
    d) dirs=`echo $OPTARG|tr , ' '|sed -e 's,$,/.git,' -e 's, ,/.git ,g'`;;
    p) add_prefix=t;;
    v) verbose=t;;
    h) usage ; exit;;
    \?) echo Unknown option ; exit;;
  esac
done
shift $(($OPTIND -1))

ngits=0
if [ -n "$dirs" ]; then
  git_dirs=$dirs
else
  if [ -f .mgit ]; then
    git_dirs=`find . -maxdepth 2 -type d -name .git|sed -e 's,./,,'`
    ngits=`echo $git_dirs|wc -w`
  fi
  if [ $ngits -le 1 ]; then
    exec git "$@";
  elif [ $ngits -gt 1 ]; then
    export MGIT_MODE=true
  fi
fi

fname_start_pattern="^\([^m]\+m\)\{0,1\}"
for gitdir in $git_dirs; do
(
  dir=`dirname $gitdir`
  # GIT_DIR has to be fullpath for git svn rebase to work
  export GIT_DIR=$PWD/$gitdir GIT_WORK_TREE=$PWD/$dir
  test -n "$verbose" && echo $lightblue$dir$reset
  test -z "$1" && continue
  if [ -n "$add_prefix" ]; then
    git $color_always "$@"|sed -e "s=$fname_start_pattern=\1$dir/=";
  else
    git $color_always "$@"
  fi
)
done
