#!/bin/sh
me=$(basename $0)

usage() {
    echo "Usage: $me -p <pid>
$me - Creates a tarball of the executable with pid <pid> with all its shared
      libraries and the core.

Options:
    -p <pid>  Process id to be bundled
    -h        Show this help message"
}

pid=
while getopts hp: opt
do
	case "$opt" in
		p)
			pid="$OPTARG"
			;;
		h)
			usage
			exit
			;;
		\?)
			echo Unknown option
			exit
			;;
	esac
done
shift $(($OPTIND -1))

if [ -z "$pid" ]; then
	echo "Invalid pid '$pid'"
fi

test "$pid" -gt 0 || { echo "pid must be numeric"; exit 1; }

proc=/proc/$pid/exe
executable=`readlink -e $proc` || { echo "Could not readlink $proc"; exit 1; }
basename=${executable##*/}
corename=${basename}.$pid.core
sharedlibs=$(gdb -ex "attach $pid" -ex 'set height 0' -ex 'set confirm off' -ex "generate-core-file $corename" -ex 'info sharedlib' -ex quit|
	sed -n '/Shared Object Library/,/^(/p'|grep -E '(Yes|No)'|
	sed -e 's,[^/]\+,,') &&
dir="${basename}.$pid" &&
mkdir "$dir" && mv "$corename" "$dir" &&
tar chf - $sharedlibs $executable|tar -C $dir -xf - &&
echo -e "gdb:\n\tgdb -ex 'set solib-absolute-prefix ./' -ex 'file .$executable' -ex 'core-file ./$corename' " > $dir/makefile &&
echo tar czf $dir.tar.gz $dir &&
tar czf $dir.tar.gz $dir
